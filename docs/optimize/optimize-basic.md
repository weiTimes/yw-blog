---
id: optimize-basic
title: 网页性能管理详解
---

## 网页生成的过程

1. HTML 代码转 DOM
2. CSS 代码转 CSSOM
3. DOM 和 CSSOM 结合，生成渲染树（包含每个节点的视觉信息）
4. 生成布局，将渲染树的所有节点进行平面合成（flow）
5. 将布局绘制到屏幕（paint）

> * 生成布局和绘制，统称为渲染（render）。
> * 生成布局和绘制，较为耗时

## 重排和重绘

**网页生成的时候，至少会渲染一次。用户访问的过程中，还会不断重新渲染。**

会导致网页重新渲染的三种情况：

* 修改 DOM
* 修改样式表
* 用户事件

重新渲染需要重新生成布局和重新绘制，前者叫重排，后者叫重绘。

注意：

* 重绘不一定发生重排（只要布局没有发生变化）
* 重排一定会引起重绘

## 对性能的影响

**提高网页性能，就是要降低"重排"和"重绘"的频率和成本，尽量少触发重新渲染。**

## 刷新率

**网页动画的每一帧（frame）都是一次重新渲染。**

一秒之间能够完成多少次重新渲染，这个指标就被称为"刷新率"（FPS: frame per second）。

如果网页动画能够做到每秒60帧，就会跟显示器同步刷新，达到最佳的视觉效果。这意味着，**一秒之内进行60次重新渲染，每次重新渲染的时间不能超过16.66毫秒**。

如果想达到60帧的刷新率，就意味着JavaScript线程每个任务的耗时，必须少于16毫秒。一个解决办法是使用Web Worker，主线程只用于UI渲染，然后跟UI渲染不相干的任务，都放在Worker线程。

## `window.requestIdleCallback()`

`requestIdleCallback(fn)` fn 执行时机是在浏览器的空闲时间，当前帧如果有空闲时间，就执行，否则，推到下一帧。

`requestIdleCallback(fn, 5000)` 如果浏览器在 5s 后还没有空闲时间，fn 会在 5s 后强制执行。

`deadline.timeRemaining()` 方法返回当前帧还剩余的毫秒，即还有多少的空闲时间。

`deadline.didTimeout` 属性表示指定的时间是否过期。

fn 如果执行了，有两种情况，一种是有空闲时间，一种是指定的时间到了。

## 参考

[网页性能管理详解](https://www.ruanyifeng.com/blog/2015/09/web-page-performance-in-depth.html)