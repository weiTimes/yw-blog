---
title: 渲染流程（上）：HTML、CSS 和 JavaScript 是如何变成页面的？
---

理解了页面的渲染流程，可以解决一些问题：

- 熟练使用开发者工具，能够理解开发者工具里面大部分项目的含义。
- 能优化页面卡顿问题。
  - 使用 Javascript 优化动画流程。
  - 通过优化样式表来防止强制同步布局。

输入的 HTML/CSS/Javascript 经过渲染流水线的处理，最终输出为屏幕上的像素。

![渲染流水线](https://ypyun.ywhoo.cn/assets/20210714220343.png)

流水线可分为以下几个子阶段：

1. 构建 DOM 树
2. 样式计算
3. 布局阶段
4. 分层
5. 绘制
6. 分块
7. 光栅化
8. 合成

每个子阶段都有**输入**、**处理过程**、**输出**。

## 构建 DOM 树

将 HTMl 转换为浏览器能够理解的结构：**DOM 树**，在浏览器控制台输入 `document` 可以查看其结构。

转换完后，还不知道 DOM 节点的样式，就需要**样式计算**了。

## 样式计算（Recalculate Style）

这一阶段计算出 DOM 节点中每个元素的具体样式，主要分 3 步来完成：

1. 把 CSS 转换为浏览器能理解的结构。
2. 转换样式表中的属性值，使其标准化。
3. 计算出 DOM 树中每个节点的具体样式。

### 把 CSS 转换为浏览器能理解的结构

CSS 样式来源：

- 通过 link 引用的外联样式
- 写在 style 标签中的内联样式
- 写在标签 style 属性上的行内样式

渲染引擎拿到 CSS 文本后，将它转换成浏览器可以理解的结构：`styleSheets`，在控制台中输入 `document.styleSheets` 可以查看其结构。

### 转换样式表中的属性值，使其标准化

这一阶段将所有值转换成渲染引擎容易理解的、标准化的计算值。

![css 计算值标准化](https://ypyun.ywhoo.cn/assets/20210714222114.png)

### 计算 DOM 树中每个节点的具体样式

样式计算过程中遵循两个规则：

1. CSS 的继承规则
2. 层叠规则

#### CSS 的继承规则

每个 DOM 节点都包含可以从父节点继承的样式，如字体大小、字体粗细、背景色等。

样式计算过程中，会根据 DOM 节点的继承关系来合理计算节点样式。

#### 层叠规则

层叠是 CSS 的一个基本特征，它是一个定义了如何合并多个源的属性值的算法。

多个源：

- 用户代理样式（User Agent）
- 网页作者
- 用户

![层叠顺序](https://ypyun.ywhoo.cn/assets/20210714231024.png)

## 布局阶段

有了 DOM 树和 DOM 树中元素的样式，还不能显示页面，因为还不知道 DOM 元素的几何位置信息。接下来需要计算出 DOM 树中可见元素的几何位置，这个计算过程成为布局。

布局阶段需要完成两个任务：

1. 创建布局树
2. 布局计算

### 创建布局树

**生成布局树**：创建可见元素的布局树。

:::note 不可见的节点
`head` 标签下的全部内容，含有 `display: none` 样式的节点。
:::

### 布局计算

有了完整的布局树，就可以计算布局树节点的坐标位置了。

在执行布局操作时，会把布局运算的结果重新写回布局树中。

## 总结

![渲染流水线](https://ypyun.ywhoo.cn/assets/20210714232014.png)

渲染流程的前三个阶段：生成 DOM 树、样式计算、生成布局树：

- 浏览器不能直接理解 HTML 数据，所以第一步需要将其转换为浏览器能够理解的 DOM 树结构；
- 生成 DOM 树后，还需要根据 CSS 样式表，来计算出 DOM 树所有节点的样式；
- 最后计算 DOM 元素的布局信息，使其都保存在布局树中。

到这里，每个节点都拥有了自己的样式和布局信息，后面几个阶段就是利用这些信息去展示页面。
